name: .NET Core Desktop

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    strategy:
      matrix:
        runtime: [win-x64, win-x86]

    runs-on: windows-latest

    env:
      Project_Name: FreeMove
      Target: net9.0-windows

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # 安装 .NET Core SDK
    - name: Install .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 9.0.x

    # 添加 MSBuild 到 PATH
    - name: Setup MSBuild.exe
      uses: microsoft/setup-msbuild@v1

    # 安装所需的工作负载
    - name: Install required workloads
      timeout-minutes: 10  # 增加超时时间
      run: |
        dotnet workload install microsoft-net-sdk-emscripten
        dotnet workload install microsoft-net-sdk-blazorwebassembly-aot
        dotnet workload install microsoft-windows-sdk-full

    # 检查已安装的运行时
    - name: Check installed runtimes
      run: dotnet --list-runtimes

    # 构建解决方案
    - name: Build the solution
      run: dotnet publish -c Release -r ${{ matrix.runtime }} --self-contained false --no-restore

    # 上传构建产物
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.Project_Name }}_${{ matrix.runtime }}.exe
        path: ${{ env.Project_Name }}/bin/Release/${{ env.Target }}/${{ matrix.runtime }}/publish/${{ env.Project_Name }}.exe